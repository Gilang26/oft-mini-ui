<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üöÄ LayerZero OFT ‚Ä¢ Mini UI</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0b1220">

  <!-- Ethers.js + fallback (antisipasi error "Can't find variable: ethers") -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" defer></script>
  <script>
    (function ensureEthers(){
      function injectFallback(){
        var s=document.createElement('script');
        s.src='https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
        s.defer=true;
        document.head.appendChild(s);
      }
      setTimeout(function(){
        if(typeof window.ethers==='undefined'){ injectFallback(); }
      }, 500);
    })();
  </script>

  <!-- Web3Modal + WalletConnect (agar bisa connect banyak wallet) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>

  <style>
    :root{
      --bg-1:#0b1220; --bg-2:#0e1628; --text:#e6edf3; --muted:#9aa6b2;
      --accent:#6ee7ff; --accent-2:#7c5cff; --ring:rgba(110,231,255,.35); --success:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card: rgba(255,255,255,.03); --stroke: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(1000px 800px at 110% 10%, rgba(110,231,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:100%; max-width:820px}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px;
      border:1px solid var(--stroke); background:var(--card); color:var(--muted); font-size:12px}
    .title{margin:12px 0 8px; text-align:center; font-weight:800; font-size:clamp(22px,4.5vw,36px);
      background:linear-gradient(90deg,var(--accent),#fff,var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .subtitle{text-align:center; color:var(--muted); margin:0 0 18px; font-size:14px}
    .card{background:linear-gradient(180deg, var(--card), rgba(255,255,255,.01)); border:1px solid var(--stroke); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid; grid-template-columns:1fr; gap:14px} @media (min-width:740px){.grid{grid-template-columns:1fr 1fr}}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--stroke); background:rgba(12,18,30,.6); color:var(--text); outline:none; transition:.2s border,.2s box-shadow,.2s transform}
    .input:focus{border-color:var(--accent); box-shadow:0 0 0 6px var(--ring); transform:translateY(-1px)}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{flex:1; min-width:140px; padding:12px 14px; border-radius:12px; border:0; font-weight:700; color:#0b1220;
      background:linear-gradient(90deg,var(--accent),var(--accent-2)); box-shadow:0 10px 24px rgba(124,92,255,.25);
      transition:transform .12s ease, filter .12s ease; cursor:pointer}
    .btn:hover{transform:translateY(-1px); filter:saturate(1.15)}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--stroke); box-shadow:none}
    .log{margin-top:14px; border:1px dashed var(--stroke); border-radius:12px; padding:12px; background:rgba(12,18,30,.4); font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; text-align:left; white-space:pre-wrap}
    .ok{color:var(--success)} .warn{color:var(--warn)} .err{color:var(--err)}
    .foot{margin-top:16px; text-align:center; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
<main class="wrap">
  <div style="text-align:center"><span class="chip">üß™ Sepolia ‚Üí Stable (EID 40374)</span></div>
  <h1 class="title">LayerZero OFT ‚Äî Mini UI</h1>
  <p class="subtitle">Approve ‚Üí Quote Fee ‚Üí Send. Nyaman dipakai di HP dan support banyak wallet.</p>

  <section class="card">
    <div class="grid" style="margin-bottom:8px">
      <div>
        <label>Alamat Tujuan (EVM)</label>
        <input class="input" id="toAddr" placeholder="0x‚Ä¶" autocomplete="off" />
        <div class="hint">Akan diubah otomatis ke <code>bytes32</code> saat kirim.</div>
      </div>
      <div>
        <label>Jumlah (LD)</label>
        <input class="input" id="amountLD" type="number" placeholder="Contoh: 1000000 (‚âô 1 USDT @6 desimal)" />
        <div class="hint">USDT 6 desimal ‚Üí 1 USDT = <b>1,000,000</b> (LD). Mulai kecil dulu ya.</div>
      </div>
    </div>

    <div class="grid" style="margin-bottom:8px">
      <div>
        <label>Token (ERC20)</label>
        <input class="input" id="token" value="0xc4DCC311c028e341fd8602D8eB89c5de94625927" />
        <div class="hint">USDT0 Sepolia (6 desimal)</div>
      </div>
      <div>
        <label>OFT Adapter</label>
        <input class="input" id="adapter" value="0xc099cD946d5efCC35A99D64E808c1430cEf08126" />
        <div class="hint">Kontrak OFTAdapter</div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Min Receive (%)</label>
        <input class="input" id="minPct" value="99" />
        <div class="hint">99 artinya minAmount = 99% dari amount</div>
      </div>
      <div>
        <label>dstEid</label>
        <input class="input" id="dstEid" value="40374" />
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <button class="btn" id="btnConnect">üîå Connect</button>
      <button class="btn ghost" id="btnApprove">‚úÖ Approve</button>
      <button class="btn ghost" id="btnQuote">üí∞ Quote Fee</button>
      <button class="btn" id="btnSend">üöÄ Send</button>
    </div>

    <div id="log" class="log">Log siap.</div>
  </section>

  <p class="foot">Dibuat oleh kamu ‚Ä¢ v2 (universal wallets)</p>
</main>

<script>
/* ========= Helper UI ========= */
const $ = id => document.getElementById(id);
const setLog = t => { $("log").textContent = t; };
const log = t => { $("log").textContent += "\\n" + t; $("log").scrollTop = $("log").scrollHeight; };

/* ========= Wait for ethers ========= */
async function waitForEthers(maxMs=6000){
  const start = Date.now();
  while (typeof window.ethers === 'undefined') {
    if (Date.now()-start > maxMs) throw new Error('ethers gagal dimuat');
    await new Promise(r=>setTimeout(r,150));
  }
}

/* ========= Web3Modal (universal connect) ========= */
let provider, signer, web3Modal, wcProvider;

function initWeb3Modal() {
  if (web3Modal) return;
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: {
        // isi infuraId / rpc jika punya untuk koneksi lebih stabil
        // infuraId: ""
      }
    }
  };
  web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions
  });
}

async function connectUniversal() {
  await waitForEthers();
  initWeb3Modal();
  try {
    // MetaMask in-app browser biasanya expose isMetaMask
    if (window.ethereum && window.ethereum.isMetaMask) {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const me = await signer.getAddress();
      setLog("‚úÖ Connected (MetaMask): " + me);
      return;
    }
    // Jika tidak ada MetaMask ‚Üí pakai Web3Modal (WalletConnect, dll)
    const ext = await web3Modal.connect();
    wcProvider = ext;
    provider = new ethers.providers.Web3Provider(ext);
    signer = provider.getSigner();
    const me = await signer.getAddress();
    setLog("‚úÖ Connected (Web3Modal): " + me);

    if (ext.on) {
      ext.on("disconnect", () => { log("üîå disconnected"); provider=null; signer=null; });
      ext.on("accountsChanged", (a)=> log("‚ÑπÔ∏è accountsChanged: " + a));
      ext.on("chainChanged", (c)=> log("‚ÑπÔ∏è chainChanged: " + c));
    }
  } catch(e){ setLog("‚ùå Connect error: " + (e.message||e)); }
}

/* ========= OFT Logic ========= */
const ERC20_ABI = [
  "function approve(address spender, uint256 value) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const OFT_ABI = [
  "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool) view returns (uint256 nativeFee,uint256 zroFee)",
  "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address) payable"
];

function toBytes32Address(addr){
  const a = ethers.utils.getAddress(addr).slice(2);
  return "0x" + a.padStart(64, "0");
}
function toBN(x){ return ethers.BigNumber.from(String(x)); }
function minAmountLD(amountLD, pct){ return toBN(amountLD).mul(pct).div(100); }

async function ensureSigner() {
  if (!signer) throw new Error("Belum terhubung wallet. Klik Connect.");
  return await signer.getAddress();
}

/* ========= Handlers ========= */
$("btnConnect").onclick = connectUniversal;

$("btnApprove").onclick = async () => {
  try{
    await waitForEthers();
    const me = await ensureSigner();
    const token = $("token").value.trim();
    const adapter = $("adapter").value.trim();
    const amountLD = $("amountLD").value.trim();
    if(!amountLD) throw new Error("Isi jumlah LD dulu (contoh 1000000).");

    const erc = new ethers.Contract(token, ERC20_ABI, signer);
    try { const d = await erc.decimals(); log("‚ÑπÔ∏è Token decimals = " + d); } catch {}
    log("Approve " + amountLD + " ke adapter...");
    const tx = await erc.approve(adapter, amountLD);
    log("Approve tx: " + tx.hash);
    await tx.wait();
    log("‚úÖ Approve confirmed.");
  }catch(e){ log("‚ùå Approve error: " + (e.message||e)); }
};

$("btnQuote").onclick = async () => {
  try{
    await waitForEthers();
    const me = await ensureSigner();
    const adapter = $("adapter").value.trim();
    const toAddr = $("toAddr").value.trim() || me;
    const amountLD = $("amountLD").value.trim();
    const pct = Number($("minPct").value.trim() || "99");
    const dstEid = Number($("dstEid").value.trim());
    if(!amountLD) throw new Error("Isi jumlah LD dulu.");

    const oft = new ethers.Contract(adapter, OFT_ABI, signer);
    const to32 = toBytes32Address(toAddr);
    const minLD = minAmountLD(amountLD, pct);
    const sendParam = { dstEid, to: to32, amountLD, minAmountLD: minLD, extraOptions:"0x", composeMsg:"0x", oftCmd:"0x" };

    const fee = await oft.quoteSend(sendParam, false);
    setLog("üí∞ nativeFee (wei): " + fee.nativeFee.toString() + "\\n‚âà " + ethers.utils.formatEther(fee.nativeFee) + " ETH");
  }catch(e){ setLog("‚ùå Quote error: " + (e.message||e)); }
};

  } catch (e) {
    setLog("‚ùå Send error: " + (e.message || e));
  }
};

async function quoteFee() {
  try {
    const amountInput = document.querySelector('input[type="number"]');
    const dstEidInput = document.querySelector('#dstEid');
    const adapterInput = document.querySelector('#adapter');

    const amount = amountInput?.value?.trim();
    const dstEid = parseInt(dstEidInput?.value?.trim() || "0");
    const adapter = adapterInput?.value?.trim();

    if (!amount || isNaN(amount)) throw new Error("‚ö†Ô∏è Jumlah belum diisi atau tidak valid!");
    if (!dstEid) throw new Error("‚ö†Ô∏è dstEid belum diisi!");
    if (!adapter) throw new Error("‚ö†Ô∏è Kontrak adapter kosong!");

    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const oft = new ethers.Contract(adapter, oftAbi, signer);

    const [nativeFee] = await oft.quoteSend(dstEid, amount, false);
    setLog(`üí∞ Estimasi Fee: ${ethers.utils.formatEther(nativeFee)} ETH`);
  } catch (err) {
    setLog(`‚ùå Quote error: ${err.message}`);
  }
}

async function sendToken() {
  try {
    const amountInput = document.querySelector('input[type="number"]');
    const dstEidInput = document.querySelector('#dstEid');
    const toInput = document.querySelector('input[placeholder*="0x"]');
    const adapterInput = document.querySelector('#adapter');

    const amount = amountInput?.value?.trim();
    const dstEid = parseInt(dstEidInput?.value?.trim() || "0");
    const to = toInput?.value?.trim();
    const adapter = adapterInput?.value?.trim();

    if (!amount || isNaN(amount)) throw new Error("Jumlah token belum diisi!");
    if (!ethers.utils.isAddress(to)) throw new Error("Alamat tujuan tidak valid!");
    if (!dstEid) throw new Error("dstEid tidak valid!");

    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const oft = new ethers.Contract(adapter, oftAbi, signer);

    const [nativeFee] = await oft.quoteSend(dstEid, amount, false);
    const tx = await oft.send(dstEid, to, amount, signer.getAddress(), "0x", { value: nativeFee });
    setLog(`üöÄ TX dikirim! Hash: ${tx.hash}`);
  } catch (err) {
    setLog(`‚ùå Send error: ${err.message}`);
  }
}
</script>
</body>
</html>
