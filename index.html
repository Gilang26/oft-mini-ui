<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Connect Test</title>
<style>
  body{font-family:system-ui,Arial;margin:0;min-height:100vh;display:grid;place-items:center;background:#0b1220;color:#e6edf3}
  .card{width:min(520px,92vw);background:#121a2a;border:1px solid #22304a;border-radius:14px;padding:18px}
  button{width:100%;padding:12px;border:0;border-radius:10px;background:#6c8cff;color:#0b1220;font-weight:700}
  pre{white-space:pre-wrap;background:#0f1625;border:1px solid #22304a;border-radius:10px;padding:10px;margin-top:12px}
</style>
<!-- ethers + fallback -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" defer></script>
<script>
(function ensureEthers(){
  setTimeout(function(){
    if(typeof window.ethers==='undefined'){
      var s=document.createElement('script');
      s.src='https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
      s.defer=true;document.head.appendChild(s);
    }
  },500);
})();
</script>
<!-- web3modal + walletconnect (fallback) -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js" defer></script>
<script src="https://unpkg.com/web3modal@1.9.8/dist/index.js" defer></script>
</head>
<body>
  <div class="card">
    <h2>üîå Wallet Connect Test</h2>
    <p>Buka halaman ini di <b>MetaMask/OKX/Trust Browser</b>, lalu tekan Connect.</p>
    <button id="btnConnect">Connect</button>
    <pre id="log">log siap‚Ä¶</pre>
  </div>

<script>
let provider, signer, web3Modal, wcProvider;
const log = (m)=>{const el=document.getElementById('log'); el.textContent+=(el.textContent?'\\n':'')+m;};

function initWeb3Modal(){
  if (web3Modal) return;
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider?.default,
      options: { rpc: { 1:"https://rpc.ankr.com/eth" } } // tidak dipakai utk Sepolia, cuma supaya init OK
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:false, providerOptions });
}

async function waitForLibs(){
  const start = Date.now();
  while (!window.ethers || !window.Web3Modal || !window.WalletConnectProvider){
    if (Date.now()-start>6000) throw new Error("Libs belum termuat (ethers/web3modal)");
    await new Promise(r=>setTimeout(r,120));
  }
}

async function connectUniversal(){
  try{
    await waitForLibs();
    // 1) injected provider dulu (MetaMask/OKX/Trust/CBW)
    let ext = null;
    if (window.ethereum) ext = window.ethereum;
    else if (window.okxwallet?.ethereum) ext = window.okxwallet.ethereum;
    else if (window.coinbaseWalletExtension) ext = window.coinbaseWalletExtension;

    if (ext){
      provider = new ethers.providers.Web3Provider(ext,'any');
      await provider.send('eth_requestAccounts',[]);
      signer = provider.getSigner();
      const me = await signer.getAddress();
      const net = await provider.getNetwork();
      log(`‚úÖ Injected connected: ${me}`);
      log(`chainId: ${net.chainId}`);
      return;
    }

    // 2) fallback: Web3Modal (WalletConnect)
    initWeb3Modal();
    const wc = await web3Modal.connect();
    wcProvider = wc;
    provider = new ethers.providers.Web3Provider(wc,'any');
    signer = provider.getSigner();
    const me = await signer.getAddress();
    const net = await provider.getNetwork();
    log(`‚úÖ WalletConnect connected: ${me}`);
    log(`chainId: ${net.chainId}`);

    if (wc.on){
      wc.on('disconnect',()=>log('üîå disconnected'));
      wc.on('accountsChanged',a=>log('accountsChanged: '+a));
      wc.on('chainChanged',c=>log('chainChanged: '+c));
    }
  }catch(e){
    log('‚ùå Connect error: '+(e.message||e));
  }
}

document.getElementById('btnConnect').onclick = connectUniversal;
</script>
</body>
</html>
