<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFT Bridge v2</title>
  <meta name="theme-color" content="#0b1220" />

  <!-- Load ethers.js dengan fallback -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    // fallback kalau window.ethers belum muncul
    (function ensureEthers() {
      if (typeof window.ethers === 'undefined') {
        const s = document.createElement('script');
        s.src = "https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js";
        s.onload = () => console.log("‚úÖ ethers fallback loaded");
        document.head.appendChild(s);
      } else {
        console.log("‚úÖ ethers loaded");
      }
    })();
  </script>

  <style>
    body {
      margin: 0; min-height: 100vh; display: grid; place-items: center;
      background: #0b1220; color: #e6edf3; font-family: system-ui, Arial, sans-serif;
    }
    .card {
      background: #121a2a; border: 1px solid #22304a; border-radius: 12px;
      padding: 28px; width: min(420px, 90vw); text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
    }
    h1 { margin-top: 0; color: #7c5cff; }
    button {
      width: 100%; padding: 12px; border: 0; border-radius: 10px;
      font-weight: 700; color: #fff; cursor: pointer; margin-top: 10px;
      font-size: 15px; transition: .2s;
    }
    #connect { background: linear-gradient(90deg,#6ee7ff,#7c5cff); }
    #bridge { background: linear-gradient(90deg,#22c55e,#16a34a); }
    input {
      width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px;
      border: 1px solid #22304a; background: #0f1625; color: #fff; font-size: 14px;
    }
    pre {
      white-space: pre-wrap; background: #0f1625; border: 1px solid #22304a;
      border-radius: 10px; padding: 10px; margin-top: 14px; text-align: left;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåâ OFT Mini Bridge v2</h1>
    <p>Bridge token antar chain dengan MetaMask / OKX / Trust</p>
    <button id="connect">üîå Connect Wallet</button>
    <input id="amount" type="number" placeholder="Jumlah token (LD, ex: 1000000)" />
    <button id="bridge" disabled>üöÄ Bridge Now</button>
    <pre id="log">log siap...</pre>
  </div>

  <script>
    let provider, signer;

    const log = (m) => {
      const el = document.getElementById("log");
      el.textContent += (el.textContent ? "\n" : "") + m;
      el.scrollTop = el.scrollHeight;
      console.log(m);
    };

    async function connect() {
      const btn = document.getElementById("connect");
      try {
        if (!window.ethereum) throw new Error("Buka di browser MetaMask/OKX/Trust/CB Wallet.");
        btn.disabled = true; btn.textContent = "‚è≥ Connecting...";
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const me = await signer.getAddress();
        const net = await provider.getNetwork();
        log(`‚úÖ Connected: ${me}\nchainId: ${net.chainId}`);
        btn.textContent = "‚úÖ Connected";
        document.getElementById("bridge").disabled = false;
      } catch (e) {
        log("‚ùå Connect error: " + (e.message || e));
        btn.disabled = false; btn.textContent = "üîå Connect Wallet";
      }
    }

    async function bridgeNow() {
      const amountInput = document.getElementById("amount").value.trim();
      if (!amountInput) return log("‚ö†Ô∏è Isi jumlah token dulu.");

      try {
        if (!signer) return log("‚ùå Hubungkan wallet dulu.");
        const me = await signer.getAddress();
        const adapter = "0xc099cD946d5efCC35A99D64E808c1430cEf08126";
        const token = "0xc4DCC311c028e341fd8602D8eB89c5de94625927";
        const dstEid = 40374;
        const amount = ethers.BigNumber.from(amountInput);
        const OFT_ABI = [
          "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool)view returns(uint256 nativeFee,uint256 zroFee)",
          "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address)payable"
        ];

        const to32 = "0x" + me.slice(2).padStart(64, "0");
        const oft = new ethers.Contract(adapter, OFT_ABI, signer);
        const sendParam = {
          dstEid, to: to32, amountLD: amount, minAmountLD: amount,
          extraOptions: "0x", composeMsg: "0x", oftCmd: "0x"
        };
        const fee = await oft.quoteSend(sendParam, false);
        log(`üí∞ Fee: ${ethers.utils.formatEther(fee.nativeFee)} ETH`);
        const tx = await oft.send(sendParam, { nativeFee: fee.nativeFee, zroFee: 0 }, me, { value: fee.nativeFee });
        log(`üöÄ TX sent: ${tx.hash}`);
        await tx.wait();
        log("‚úÖ Bridge confirmed!");
      } catch (e) {
        log("‚ùå Bridge error: " + (e.message || e));
      }
    }

    document.getElementById("connect").onclick = connect;
    document.getElementById("bridge").onclick = bridgeNow;
  </script>
</body>
</html>
